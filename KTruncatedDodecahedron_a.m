clear
%% unit cell model definition
L = 1;  r0 = 1e-2; t = r0/4;
Es = 7e7; nu = 0.3; Gm = Es/2/(1+nu);
Area = pi*r0^2;
Ixx = r0^4/12; Iyy = r0^4/12; Izz = 2*r0^4/12;

nodes = [0., -1.618033988749895, 2.48989828488278;0., -1.618033988749895, -2.48989828488278;0., 1.618033988749895, 2.48989828488278;0., 1.618033988749895, -2.48989828488278;0.42532540417601994, -2.9270509831248424, 0.2628655560595668;0.42532540417601994, 2.9270509831248424, 0.2628655560595668;0.6881909602355868, -2.118033988749895, 1.9641671727636467;0.6881909602355868, 2.118033988749895, 1.9641671727636467;-2.752763840942347, 0., -1.1135163644116066;-2.0645728807067605, -2.118033988749895, 0.2628655560595668;-2.0645728807067605, 2.118033988749895, 0.2628655560595668;-1.3763819204711736, -2.618033988749895, -0.2628655560595668;-1.3763819204711736, 2.618033988749895, -0.2628655560595668;-0.6881909602355868, -2.118033988749895, -1.9641671727636467;-0.6881909602355868, 2.118033988749895, -1.9641671727636467;1.3763819204711736, -2.618033988749895, 0.2628655560595668;1.3763819204711736, 2.618033988749895, 0.2628655560595668;2.752763840942347, 0., 1.1135163644116066;1.8017073246471935, -1.3090169943749475, -1.9641671727636467;1.8017073246471935, 1.3090169943749475, -1.9641671727636467;2.0645728807067605, -2.118033988749895, -0.2628655560595668;2.0645728807067605, 2.118033988749895, -0.2628655560595668;2.2270327288232132, 0., 1.9641671727636467;2.2270327288232132, -1.618033988749895, -1.1135163644116066;2.2270327288232132, 1.618033988749895, -1.1135163644116066;-2.6523581329992334, -1.3090169943749475, 0.2628655560595668;-2.6523581329992334, 1.3090169943749475, 0.2628655560595668;2.6523581329992334, -1.3090169943749475, -0.2628655560595668;2.6523581329992334, 1.3090169943749475, -0.2628655560595668;2.9152236890588, -0.5, 0.2628655560595668;2.9152236890588, 0.5, 0.2628655560595668;-2.9152236890588, -0.5, -0.2628655560595668;-2.9152236890588, 0.5, -0.2628655560595668;0.9510565162951535, -1.3090169943749475, 2.48989828488278;0.9510565162951535, -1.3090169943749475, -2.48989828488278;0.9510565162951535, 1.3090169943749475, 2.48989828488278;0.9510565162951535, 1.3090169943749475, -2.48989828488278;0.85065080835204, -2.618033988749895, 1.1135163644116066;0.85065080835204, 2.618033988749895, 1.1135163644116066;-0.9510565162951535, -1.3090169943749475, 2.48989828488278;-0.9510565162951535, -1.3090169943749475, -2.48989828488278;-0.9510565162951535, 1.3090169943749475, 2.48989828488278;-0.9510565162951535, 1.3090169943749475, -2.48989828488278;-1.5388417685876268, -0.5, 2.48989828488278;-1.5388417685876268, -0.5, -2.48989828488278;-1.5388417685876268, 0.5, 2.48989828488278;-1.5388417685876268, 0.5, -2.48989828488278;1.5388417685876268, -0.5, 2.48989828488278;1.5388417685876268, -0.5, -2.48989828488278;1.5388417685876268, 0.5, 2.48989828488278;1.5388417685876268, 0.5, -2.48989828488278;-2.2270327288232137, 0., -1.9641671727636467;-2.2270327288232137, -1.618033988749895, 1.1135163644116066;-2.2270327288232137, 1.618033988749895, 1.1135163644116066;-0.8506508083520399, -2.618033988749895, -1.1135163644116066;-0.8506508083520399, 2.618033988749895, -1.1135163644116066;-1.8017073246471933, -1.3090169943749475, 1.9641671727636467;-1.8017073246471933, 1.3090169943749475, 1.9641671727636467;-0.42532540417601994, -2.9270509831248424, -0.2628655560595668;-0.42532540417601994, 2.9270509831248424, -0.2628655560595668]*L;
beams = struct('nodes', [1, 7;1, 34;1, 40;2, 14;2, 35;2, 41;3, 8;3, 36;3, 42;4, 15;4, 37;4, 43;5, 16;5, 38;5, 59;6, 17;6, 39;6, 60;7, 34;7, 38;8, 36;8, 39;9, 32;9, 33;9, 52;10, 12;10, 26;10, 53;11, 13;11, 27;11, 54;12, 55;12, 59;13, 56;13, 60;14, 41;14, 55;15, 43;15, 56;16, 21;16, 38;17, 22;17, 39;18, 23;18, 30;18, 31;19, 24;19, 35;19, 49;20, 25;20, 37;20, 51;21, 24;21, 28;22, 25;22, 29;23, 48;23, 50;24, 28;25, 29;26, 32;26, 53;27, 33;27, 54;28, 30;29, 31;30, 31;32, 33;34, 48;35, 49;36, 50;37, 51;40, 44;40, 57;41, 45;42, 46;42, 58;43, 47;44, 46;44, 57;45, 47;45, 52;46, 58;47, 52;48, 50;49, 51;53, 57;54, 58;55, 59;56, 60]);

mat = struct('E', Es, 'nu', nu);
prop.beams = struct('A', Area, ...
    'Ixx', Ixx, 'Iyy', Iyy, 'Izz', Izz);
model = struct('nodes', nodes, 'beams',  beams, ...
    'mat', mat, 'prop', prop);
%% periodic directions
dirs = [01,17; 30,44; 06,19];
a1 = (model.nodes(dirs(1,2),:)-model.nodes(dirs(1,1), :))';
a2 = (model.nodes(dirs(2,2),:)-model.nodes(dirs(2,1), :))';
a3 = (model.nodes(dirs(3,2),:)-model.nodes(dirs(3,1), :))';
%% plot unit cell
figure(4); clf

plot3DModel(model, [],...
    struct('nodeslabels', false, 'FontSize', 18, ...
    'plotundef', true, 'undeflinewidth', 1, 'undeflinestyle', '-', ...
    'undeflinecolor', 'b'));

plot3DModel(model, [],...
    struct('nodeslabels', true, 'FontSize', 18, ...
    'plotundef', true, 'undeflinewidth', 6, 'undeflinestyle', '-'));
xlabel('x'); ylabel('y'); zlabel('z');

daspect([1, 1, 1]); view(3)
light('Position',[1 1 1],'Style','infinite');
set(gca, 'Visible', 'off')
myaxis = axis;
shg
p0 = -[1,1,1]/10;
cg = mean(nodes);
set(quiver3(cg(1), cg(2), cg(3), a1(1), a1(2), a1(3), 1), ...
    'linewidth', 2, 'color', 'b');
set(text(cg(1)+a1(1), cg(2)+a1(2), cg(3)+a1(3), 'a$_1$'), ...
    'fontSize', 18, 'interpreter', 'latex');

set(quiver3(cg(1), cg(2), cg(3), a2(1), a2(2), a2(3), 1), ...
    'linewidth', 2, 'color', 'b');
set(text(cg(1)+a2(1), cg(2)+a2(2), cg(3)+a2(3), 'a$_2$'), ...
    'fontSize', 18, 'interpreter', 'latex');
set(quiver3(cg(1), cg(2), cg(3), a3(1), a3(2), a3(3), 1), ...
    'linewidth', 2, 'color', 'b');
set(text(cg(1)+a3(1), cg(2)+a3(2), cg(3)+a3(3), 'a$_3$'), ...
    'fontSize', 18, 'interpreter', 'latex');

camlight; lighting phong; material metal;
alpha (0.25);
%% find material properties
[Keps, Vol, Vol0, deps] = Find3DMatProp(model, a1, a2, a3);

fprintf ('the material volume of the unit cell is : %.4f\n', Vol);
fprintf ('the volume of the unit cell is          : %.4f\n', Vol0);
fprintf ('the relative density of the lattice is  : %.4f\n', Vol/Vol0);
fprintf ('the lattice stiffnes matrix is : \n');
disp (Keps);
%% plot pure deformation modes of the unit cell

nnodes = size(model.nodes,1);
stitles = {{'$\epsilon_{11} = 1, \epsilon_{22} = 0, \epsilon_{33} = 0$', ...
    '$\gamma_{12} = 0, \gamma_{23} = 0, \gamma_{31} = 0$'}, ...
    {'$\epsilon_{11} = 0, \epsilon_{22} = 1, \epsilon_{33} = 0$', ...
    '$\gamma_{12} = 0, \gamma_{23} = 0, \gamma_{31} = 0$'}, ...
    {'$\epsilon_{11} = 0, \epsilon_{22} = 0, \epsilon_{33} = 1$', ...
    '$\gamma_{12} = 0, \gamma_{23} = 0, \gamma_{31} = 0$'}, ...
    {'$\epsilon_{11} = 0, \epsilon_{22} = 0, \epsilon_{33} = 0$', ...
    '$\gamma_{12} = 0, \gamma_{23} = 1, \gamma_{31} = 0$'}, ...
    {'$\epsilon_{11} = 0, \epsilon_{22} = 0, \epsilon_{33} = 0$', ...
    '$\gamma_{12} = 0, \gamma_{23} = 0, \gamma_{31} = 1$'}, ...
    {'$\epsilon_{11} = 0, \epsilon_{22} = 0, \epsilon_{33} = 0$', ...
    '$\gamma_{12} = 1, \gamma_{23} = 0, \gamma_{31} = 0$'}};

figure(2); clf
set(gcf, 'position', [20, 400, 1200, 800]);
for nMode = 1:6
    subplot(2, 3, nMode); set(gca, 'fontSize', 14);
    
    disp0 = reshape(deps(:,nMode), 6, nnodes)';
    plot3DModel(model, disp0,...
        struct('nodeslabels', false, 'FontSize', 18, ...
        'plotundef', true, 'undeflinewidth', 2, 'undeflinestyle', '-', ...
        'plotdef', true, 'linewidth', 4, 'maxdisp', 0.3,...
        'drawplates', false, 'NPoints', 20, ...
        'drawfaces', true, 'facecolor', 'g'));
    set(title(stitles{nMode}), 'interpreter', 'latex');
    set(xlabel('x$_1$'), 'interpreter', 'latex');
    set(ylabel('x$_2$'), 'interpreter', 'latex');
    set(zlabel('x$_3$'), 'interpreter', 'latex');
    set(gca, 'xtick', [], 'ytick', [], 'ztick', []);
    view (-13.5, 12);
end
shg

